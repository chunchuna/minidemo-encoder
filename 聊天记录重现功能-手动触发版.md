# CS:GO Demo 聊天记录手动播放功能

## 功能说明

这是一个**简化版的聊天重现功能**，不会自动同步播放聊天，而是让玩家使用 **`!saychat`** 命令手动触发，每次随机播放一条聊天消息。

## 特点

✅ **简单易用** - 只需输入 `!saychat` 就能随机播放一条聊天  
✅ **手动控制** - 想什么时候播放就什么时候播放  
✅ **随机有趣** - 每次都是随机抽取一条消息  
✅ **自动加载** - 回放开始时自动加载聊天记录  

## 使用方法

### 1. 编译插件

需要编译两个插件：

```bash
# 进入编译目录
cd addons/sourcemod/scripting/

# 编译聊天重现插件
spcomp demo_chat_replay.sp

# 编译 demomimic_test 插件
spcomp demomimic_test.sp

# 复制到 plugins 目录
copy demo_chat_replay.smx ..\plugins\
copy demomimic_test.smx ..\plugins\
```

### 2. 游戏中使用

#### 步骤 1：开始回放
```
!testdemo
```
选择要回放的比赛

#### 步骤 2：播放聊天
回合开始后，游戏会提示：
```
[Chat Replay] 💬 Loaded 15 chat messages - Use !saychat to play
[Chat Replay] 💬 已加载 15 条聊天 - 使用 !saychat 播放
```

#### 步骤 3：随机播放聊天
输入命令：
```
!saychat
```
或者
```
saychat
```

每次执行都会随机播放一条聊天消息！

## 命令列表

| 命令 | 说明 | 示例 |
|------|------|------|
| `!saychat` | 随机播放一条聊天 | `!saychat` |
| `saychat` | 同上（不带 ! 也可以） | `saychat` |
| `!chat_toggle` | 开关聊天功能 | `!chat_toggle` |
| `!testdemo` | 打开回放菜单 | `!testdemo` |

## 聊天消息显示效果

当你使用 `!saychat` 时，会看到：

```
[CHAT] (T) dev1ce: nice shot
[Chat Replay] Played message 5/15
[Chat Replay] 播放了第 5/15 条消息
```

## 配置

### ConVar 设置

可以在 `server.cfg` 或控制台中设置：

```cfg
// 启用/禁用聊天重现
sm_match_chat_replay 1    // 1=启用, 0=禁用
```

### 默认设置

插件默认已启用聊天重现功能，无需额外配置。

## 常见问题

### Q1: 提示"No chat messages loaded!"怎么办？

**原因：**
- 当前回合没有聊天记录
- demo 文件中没有聊天消息
- 聊天文件丢失

**解决方法：**
1. 确认 demo 解析时生成了聊天文件（`roundX_chat.txt`）
2. 检查文件是否在正确的位置
3. 重新开始一个回放

### Q2: 每次都播放相同的消息吗？

**不会！** 每次使用 `!saychat` 都会**随机**选择一条不同的消息播放。

### Q3: 可以连续播放多条吗？

**可以！** 只需要多次输入 `!saychat` 即可：

```
!saychat
!saychat
!saychat
```

每次都会随机播放不同的消息。

### Q4: 如何查看总共有多少条聊天？

每次使用 `!saychat` 后，会显示：
```
[Chat Replay] Played message 5/15
```
这表示总共有 15 条消息，刚播放的是第 5 条。

### Q5: 如何关闭聊天功能？

使用命令：
```
!chat_toggle
```

或者在配置文件中设置：
```
sm_match_chat_replay 0
```

## 完整工作流程

### 1. 准备阶段

```bash
# 解析 demo 文件（生成聊天记录）
cd minidemo-encoder
minidemo-encoder.exe -dir="demo文件夹"

# 复制输出文件到服务器
# output/[tickrate][demoName]/ -> csgo/addons/sourcemod/data/botmimic/demotest/[地图]/[比赛编号]/
```

### 2. 服务器配置

```bash
# 编译插件
cd addons/sourcemod/scripting/
spcomp demo_chat_replay.sp
spcomp demomimic_test.sp

# 安装插件
copy *.smx ..\plugins\
```

### 3. 游戏中使用

```
1. 玩家进入服务器
2. 输入: !testdemo
3. 选择要回放的比赛
4. 等待回合开始
5. 看到提示: "Loaded X chat messages - Use !saychat to play"
6. 输入: !saychat
7. 看到随机播放的聊天消息！
8. 继续输入 !saychat 播放更多消息
```

## 使用场景

### 场景 1：暖场娱乐
```
服主：!saychat
[CHAT] (CT) s1mple: rush B no stop
所有人：哈哈哈
```

### 场景 2：学习职业选手交流
```
玩家：!saychat
[CHAT] (T) NiKo: smoke mid
玩家：原来这波要烟中路
```

### 场景 3：连续播放制造气氛
```
!saychat
[CHAT] (T) dev1ce: nice
!saychat
[CHAT] (CT) ZywOo: ns
!saychat
[CHAT] (T) NiKo: gg
```

## 技术细节

### 聊天文件格式

插件会读取 `roundX_chat.txt` 文件，格式如下：

```
=== Chat Messages - Round 1 ===
Total Messages: 3
============================================================

[1] Tick: 5230
    Type: All
    Sender: dev1ce (Team: T)
    Message: nice shot

[2] Tick: 8450
    Type: Team
    Sender: s1mple (Team: CT)
    Message: rushing B
```

### 消息加载时机

- **加载时机**：回合冻结时间结束时（`Event_FreezeTimeEnd`）
- **清空时机**：回合结束时（`Event_RoundEnd`）
- **存储位置**：插件内存中（`g_hChatMessages`）

### 随机算法

使用 SourceMod 的 `GetRandomInt()` 函数从消息列表中随机选择：

```sourcepawn
int randomIndex = GetRandomInt(0, g_hChatMessages.Length - 1);
```

## 高级功能（可选）

### 自定义聊天显示格式

修改 `demo_chat_replay.sp` 中的 `DisplayChatMessage` 函数：

```sourcepawn
void DisplayChatMessage(ChatMessageInfo msg)
{
    // 自定义格式
    char sFormattedMsg[512];
    Format(sFormattedMsg, sizeof(sFormattedMsg), 
        "\x01[\x06回放\x01] %s: %s",  // 使用中文标签
        msg.sender, msg.message);
    
    PrintToChatAll("%s", sFormattedMsg);
}
```

### 添加冷却时间

防止玩家刷屏，可以添加冷却：

```sourcepawn
float g_fLastChatTime[MAXPLAYERS+1];
float g_fChatCooldown = 3.0;  // 3秒冷却

public Action Cmd_SayRandomChat(int client, int args)
{
    float currentTime = GetGameTime();
    if(currentTime - g_fLastChatTime[client] < g_fChatCooldown)
    {
        PrintToChat(client, "\x02[Chat] \x01Please wait %.1f seconds", 
            g_fChatCooldown - (currentTime - g_fLastChatTime[client]));
        return Plugin_Handled;
    }
    
    g_fLastChatTime[client] = currentTime;
    
    // ... 原有代码 ...
}
```

## 与自动播放版本的区别

| 特性 | 手动触发版 | 自动同步版 |
|------|-----------|----------|
| 播放方式 | 使用 `!saychat` 手动触发 | 根据时间自动播放 |
| 时间同步 | 无需同步 | 需要精确同步 tickrate |
| 使用难度 | 简单 | 较复杂 |
| 趣味性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 真实性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 推荐场景 | 娱乐服、社区服 | 竞技服、教学服 |

## 总结

**手动触发版的优势：**
- ✅ 更简单易用
- ✅ 不依赖精确的时间同步
- ✅ 玩家主动参与，更有趣
- ✅ 适合社区娱乐

**适用于：**
- 社区服务器
- 娱乐模式
- 快速测试
- 不需要完全还原比赛的场景

享受你的聊天重现功能吧！🎉 