# 新功能清单

本文档列出了为 minidemo-encoder 项目新增的所有功能和文件。

## 📦 新增功能

### 1. 批量解析功能 ✨

可以一次性解析文件夹中的所有 demo 文件，每个 demo 的输出会保存在独立的子文件夹中。

**相关文件：**
- `cmd/main.go` - 主程序（已更新）
- `internal/encoder/encoder.go` - 编码器（已更新，添加了状态重置功能）
- `batch_parse.bat` - Windows 批量解析脚本
- `batch_parse.sh` - Linux/Mac 批量解析脚本
- `批量解析说明.md` - 批量解析功能详细文档

**主要特性：**
- ✅ 自动扫描指定文件夹中的所有 `.dem` 文件
- ✅ 每个 demo 输出到独立文件夹（以 demo 名称命名）
- ✅ 自动编译并运行
- ✅ 详细的进度显示
- ✅ 状态重置机制，避免数据混乱

### 2. REC 文件平衡工具 🔄

自动检测并补全 rec 文件，确保每个 t/ct 文件夹都有 5 个不同的 rec 文件。

**相关文件：**
- `cmd/rec_balancer/main.go` - REC 平衡工具主程序（新建）
- `rec_balance.bat` - Windows REC 平衡脚本
- `rec_balance.sh` - Linux/Mac REC 平衡脚本
- `REC平衡工具说明.md` - REC 平衡工具详细文档

**主要特性：**
- ✅ 自动识别地图文件夹（de_dust2, cs_office 等）
- ✅ 智能补全规则（同地图、同队伍）
- ✅ 可以从同一局的其他回合或不同局的回合复制
- ✅ 避免重复文件
- ✅ 自动处理文件名冲突
- ✅ 详细的操作日志

### 3. 文档和指南 📖

**相关文件：**
- `快速开始.md` - 快速上手指南
- `新功能清单.md` - 本文档
- `test_workflow.bat` - 工作流程测试脚本
- `README.md` - 主 README（已更新）

## 📂 文件结构

```
minidemo-encoder/
├── cmd/
│   ├── main.go                    # 主程序（已更新）
│   └── rec_balancer/
│       └── main.go                # REC 平衡工具 ⭐新增
├── internal/
│   └── encoder/
│       └── encoder.go             # 编码器（已更新）
├── batch_parse.bat                # Windows 批量解析 ⭐新增
├── batch_parse.sh                 # Linux/Mac 批量解析 ⭐新增
├── rec_balance.bat                # Windows REC 平衡 ⭐新增
├── rec_balance.sh                 # Linux/Mac REC 平衡 ⭐新增
├── test_workflow.bat              # 工作流程测试 ⭐新增
├── 批量解析说明.md                 # 批量解析文档 ⭐新增
├── REC平衡工具说明.md              # 平衡工具文档 ⭐新增
├── 快速开始.md                     # 快速指南 ⭐新增
├── 新功能清单.md                   # 本文档 ⭐新增
└── README.md                      # 主文档（已更新）
```

## 🚀 快速使用

### Windows 用户

1. **批量解析 demo：**
   ```batch
   batch_parse.bat "D:\CSGO\demos"
   ```

2. **平衡 rec 文件：**
   ```batch
   rec_balance.bat "D:\...\botmimic\demotest"
   ```

3. **测试工作流程：**
   ```batch
   test_workflow.bat
   ```

### Linux/Mac 用户

1. **添加执行权限：**
   ```bash
   chmod +x batch_parse.sh rec_balance.sh
   ```

2. **批量解析 demo：**
   ```bash
   ./batch_parse.sh /path/to/demos
   ```

3. **平衡 rec 文件：**
   ```bash
   ./rec_balance.sh /path/to/botmimic/demotest
   ```

## 📋 更新内容

### cmd/main.go

**新增：**
- `parseDemoDirectory()` 函数 - 批量解析功能
- 状态重置调用 - 避免多 demo 之间数据混乱
- 详细的进度显示和统计

### internal/encoder/encoder.go

**新增：**
- `SetOutputSubDir()` 函数 - 设置输出子目录
- `ResetState()` 函数 - 重置全局状态
- `outputSubDir` 变量 - 存储当前输出子目录

**更新：**
- `WriteToRecFile()` 函数 - 支持子目录输出

### cmd/rec_balancer/main.go（全新文件）

完整的 REC 文件平衡工具，包含：
- 地图文件夹识别
- t/ct 文件夹扫描
- 智能文件复制
- 冲突处理
- 详细日志

## 🎯 使用场景

### 场景 1：批量处理职业比赛录像

```batch
REM 从 HLTV 下载多个职业比赛 demo
REM 放在 D:\CSGO\pro_demos 文件夹

REM 批量解析
batch_parse.bat "D:\CSGO\pro_demos"

REM 输出在 output 文件夹
REM 每个比赛一个子文件夹
```

### 场景 2：游戏服务器部署

```batch
REM 1. 批量解析 demo
batch_parse.bat "D:\demos"

REM 2. 复制到游戏服务器
xcopy /E /I output "D:\...\botmimic\demotest"

REM 3. 平衡 rec 文件
rec_balance.bat "D:\...\botmimic\demotest"

REM 4. 在游戏中使用 BotMimic 插件加载
```

### 场景 3：单地图深度分析

```batch
REM 收集某个地图（如 de_dust2）的多个 demo
REM 批量解析后使用平衡工具确保数据完整
REM 用于战术分析或训练
```

## 🔧 技术细节

### 批量解析实现要点

1. **文件扫描：** 使用 `filepath.Walk` 递归扫描
2. **状态管理：** 每个 demo 解析后调用 `ResetState()`
3. **子目录输出：** 通过 `SetOutputSubDir()` 动态设置

### REC 平衡实现要点

1. **地图识别：** 基于前缀匹配（de_, cs_, ar_ 等）
2. **文件收集：** 扫描整个地图目录下的所有 t/ct 文件夹（包括同一局的不同回合和不同局的回合）
3. **智能复制：** 只要不是同一个文件夹（同一局同一回合）就可以复制，避免重复
4. **文件名处理：** 不区分大小写，自动添加后缀

## ⚠️ 注意事项

1. **备份数据：** 首次使用前建议备份原始数据
2. **路径格式：** Windows 使用反斜杠 `\`，Linux/Mac 使用斜杠 `/`
3. **文件权限：** Linux/Mac 需要给脚本添加执行权限
4. **Demo 来源：** 避免使用完美平台的 demo（格式不兼容）
5. **目标数量：** REC 平衡工具默认补全到 5 个文件

## 📈 性能优化

- 批量解析使用顺序处理，避免内存占用过大
- REC 平衡采用一次扫描多次复制策略
- 文件操作使用标准库，兼容性好

## 🔍 调试和日志

所有工具都提供详细的输出信息：
- 批量解析：显示当前进度、文件名、状态
- REC 平衡：显示扫描结果、复制操作、统计信息
- 错误处理：清晰的错误提示和解决建议

## 📞 支持和反馈

如有问题或建议，请：
1. 查看相关文档（批量解析说明.md、REC平衡工具说明.md）
2. 运行 test_workflow.bat 测试环境
3. 检查 Go 版本和依赖
4. 查看程序输出的详细日志

## 🎉 总结

新增功能大幅提升了工作效率：
- **批量解析：** 一次处理多个 demo，自动组织输出
- **REC 平衡：** 自动补全文件，确保数据完整性
- **完整文档：** 详细的使用说明和示例
- **跨平台支持：** Windows、Linux、Mac 全支持

欢迎使用！🚀 