# CS:GO Demo èŠå¤©è®°å½•é‡ç°åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

è¿™ä¸ªåŠŸèƒ½å¯ä»¥ä» CS:GO demo æ–‡ä»¶ä¸­è§£æèŠå¤©æ¶ˆæ¯ï¼Œå¹¶åœ¨æ¸¸æˆä¸­é€šè¿‡ SourceMod æ’ä»¶é‡ç°è¿™äº›èŠå¤©å†…å®¹ï¼Œè®©è§‚ä¼—å¯ä»¥åœ¨è§‚çœ‹ bot å›æ”¾æ—¶çœ‹åˆ°åŸå§‹æ¯”èµ›ä¸­çš„èŠå¤©äº¤æµã€‚

## ä¸€ã€Demo è§£æéƒ¨åˆ†ï¼ˆGo è¯­è¨€ï¼‰

### 1.1 èŠå¤©è®°å½•ä¿å­˜ä½ç½®

è§£æåçš„èŠå¤©è®°å½•ä¼šä¿å­˜åœ¨ä»¥ä¸‹ä½ç½®ï¼š

```
output/
â”œâ”€â”€ [tickrate][demoName]/                    # Demo è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ [demoName]_chat.txt                  # å®Œæ•´èŠå¤©è®°å½•ï¼ˆTXTæ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ [demoName]_chat.csv                  # å®Œæ•´èŠå¤©è®°å½•ï¼ˆCSVæ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ round1_chat.txt                      # ç¬¬1å›åˆèŠå¤©è®°å½•
â”‚   â”œâ”€â”€ round2_chat.txt                      # ç¬¬2å›åˆèŠå¤©è®°å½•
â”‚   â”œâ”€â”€ round3_chat.txt                      # ç¬¬3å›åˆèŠå¤©è®°å½•
â”‚   â””â”€â”€ round1_T0-CT0/                       # å›åˆå½•åƒæ–‡ä»¶å¤¹
â”‚       â”œâ”€â”€ t/                               # Tæ–¹å½•åƒ
â”‚       â”œâ”€â”€ ct/                              # CTæ–¹å½•åƒ
â”‚       â””â”€â”€ chat.txt                         # ï¼ˆæœªæ¥åŠŸèƒ½ï¼šç›´æ¥åœ¨å›åˆæ–‡ä»¶å¤¹ä¸­ï¼‰
```

### 1.2 èŠå¤©è®°å½•æ–‡ä»¶æ ¼å¼

#### TXT æ ¼å¼ç¤ºä¾‹ï¼ˆ`round1_chat.txt`ï¼‰ï¼š
```
=== Chat Messages - Round 1 ===
Total Messages: 3
============================================================

[1] Tick: 5230
    Type: All
    Sender: dev1ce (Team: T)
    Message: nice shot

[2] Tick: 8450
    Type: Team
    Sender: s1mple (Team: CT)
    Message: rushing B

[3] Tick: 12300
    Type: All
    Sender: ZywOo (Team: T)
    Message: gg
```

#### CSV æ ¼å¼ç¤ºä¾‹ï¼ˆ`[demoName]_chat.csv`ï¼‰ï¼š
```csv
Tick,ChatType,Sender,Team,Message
5230,All,"dev1ce",T,"nice shot"
8450,Team,"s1mple",CT,"rushing B"
12300,All,"ZywOo",T,"gg"
```

### 1.3 ä½¿ç”¨æ–¹æ³•

ç¼–è¯‘å¹¶è¿è¡Œè§£æå™¨ï¼š

```bash
cd minidemo-encoder
go build -o minidemo-encoder.exe .\cmd\main.go

# è§£æå•ä¸ªdemo
minidemo-encoder.exe -file="path\to\demo.dem"

# æ‰¹é‡è§£æ
minidemo-encoder.exe -dir="path\to\demo\folder"
```

è§£æè¿‡ç¨‹ä¸­ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºèŠå¤©æ¶ˆæ¯ï¼š
```
[Chat][Round 1][All] dev1ce (T): nice shot
[Chat][Round 2][Team] s1mple (CT): rushing B
```

## äºŒã€æ¸¸æˆå†…é‡ç°éƒ¨åˆ†ï¼ˆSourceMod æ’ä»¶ï¼‰

### 2.1 æ’ä»¶æ–‡ä»¶

éœ€è¦ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š

1. **`demo_chat_replay.sp`** - ä¸»æ’ä»¶ï¼ˆæä¾›èŠå¤©é‡ç°åŠŸèƒ½ï¼‰
2. **`demo_chat_replay.inc`** - å¤´æ–‡ä»¶ï¼ˆä¾›å…¶ä»–æ’ä»¶è°ƒç”¨ï¼‰

### 2.2 å®‰è£…æ’ä»¶

1. ç¼–è¯‘æ’ä»¶ï¼š
```bash
# å°† demo_chat_replay.sp æ”¾å…¥ scripting/ ç›®å½•
# ç¼–è¯‘
spcomp demo_chat_replay.sp
```

2. å¤åˆ¶æ–‡ä»¶ï¼š
```
addons/sourcemod/plugins/demo_chat_replay.smx
addons/sourcemod/scripting/include/demo_chat_replay.inc
```

### 2.3 ä½¿ç”¨å‘½ä»¤

æ’ä»¶æä¾›ä»¥ä¸‹æ§åˆ¶å°å‘½ä»¤ï¼š

| å‘½ä»¤ | è¯´æ˜ | æƒé™ |
|------|------|------|
| `sm_chatreplay_test <æ–‡ä»¶è·¯å¾„>` | æµ‹è¯•æ’­æ”¾èŠå¤©è®°å½• | Admin (CONFIG) |
| `sm_chatreplay_stop` | åœæ­¢èŠå¤©é‡ç° | Admin (CONFIG) |

ç¤ºä¾‹ï¼š
```
sm_chatreplay_test "addons/sourcemod/data/botmimic/demotest/de_dust2/1/round1_chat.txt"
```

### 2.4 é›†æˆåˆ° demomimic_test

è¦åœ¨ `demomimic_test.sp` ä¸­é›†æˆèŠå¤©é‡ç°åŠŸèƒ½ï¼Œéœ€è¦åšä»¥ä¸‹ä¿®æ”¹ï¼š

#### æ­¥éª¤ 1ï¼šæ·»åŠ  include

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ï¼š
```sourcepawn
#include <sourcemod>
#include <sdktools>
#include <cstrike>
#include <botmimic>
#include <demo_chat_replay>  // æ·»åŠ è¿™ä¸€è¡Œ
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ å…¨å±€å˜é‡

```sourcepawn
// Chat replay support
bool g_bChatReplayEnabled = true;
ConVar g_cvChatReplayEnabled;
char g_sCurrentRoundChatFile[PLATFORM_MAX_PATH];
float g_fCurrentTickrate = 64.0;
```

#### æ­¥éª¤ 3ï¼šåœ¨ OnPluginStart ä¸­æ·»åŠ 

```sourcepawn
public void OnPluginStart()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // Chat replay ConVar
    g_cvChatReplayEnabled = CreateConVar("sm_match_chat_replay", "1", 
        "Enable chat replay during match replay (0=off, 1=on)", 
        FCVAR_NONE, true, 0.0, true, 1.0);
    g_bChatReplayEnabled = g_cvChatReplayEnabled.BoolValue;
    
    // Chat replay command
    RegConsoleCmd("sm_chat_toggle", Cmd_ToggleChatReplay, 
        "Toggle chat replay on/off");
}
```

#### æ­¥éª¤ 4ï¼šæ·»åŠ åˆ‡æ¢å‘½ä»¤

```sourcepawn
public Action Cmd_ToggleChatReplay(int client, int args)
{
    g_bChatReplayEnabled = !g_bChatReplayEnabled;
    g_cvChatReplayEnabled.SetBool(g_bChatReplayEnabled);
    
    if(client > 0)
    {
        if(g_bChatReplayEnabled)
        {
            PrintToChat(client, "\x04[Chat Replay] \x01èŠå¤©é‡ç°å·²å¯ç”¨");
            PrintToChat(client, "\x04[Chat Replay] \x01Chat replay enabled");
        }
        else
        {
            PrintToChat(client, "\x04[Chat Replay] \x01èŠå¤©é‡ç°å·²å…³é—­");
            PrintToChat(client, "\x04[Chat Replay] \x01Chat replay disabled");
            
            // Stop current replay if active
            if(LibraryExists("demo_chat_replay"))
            {
                DemoChatReplay_Stop();
            }
        }
    }
    
    return Plugin_Handled;
}
```

#### æ­¥éª¤ 5ï¼šåœ¨åŠ è½½å›åˆæ—¶å¯åŠ¨èŠå¤©é‡ç°

åœ¨ `Timer_PrepareMatchRound` å‡½æ•°ä¸­æ·»åŠ ï¼ˆçº¦ç¬¬1960è¡Œé™„è¿‘ï¼‰ï¼š

```sourcepawn
public Action Timer_PrepareMatchRound(Handle timer)
{
    // ... ç°æœ‰çš„åŠ è½½ä»£ç  ...
    
    LoadRecordsFromFolder(sTPath, g_hPendingTRecords);
    LoadRecordsFromFolder(sCtPath, g_hPendingCtRecords);
    
    // ===== åœ¨è¿™é‡Œæ·»åŠ èŠå¤©é‡ç°åŠŸèƒ½ =====
    if(g_bChatReplayEnabled && LibraryExists("demo_chat_replay"))
    {
        // æ„å»ºèŠå¤©æ–‡ä»¶è·¯å¾„
        char sChatFile[PLATFORM_MAX_PATH];
        Format(sChatFile, sizeof(sChatFile), "%s_chat.txt", sRoundPath);
        
        // å°è¯•æŸ¥æ‰¾ roundX_chat.txt æ–‡ä»¶
        if(!FileExists(sChatFile))
        {
            // å°è¯•åœ¨ round æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ chat.txt
            Format(sChatFile, sizeof(sChatFile), "%s%cchat.txt", 
                sRoundPath, PATH_SEPARATOR_CHAR);
        }
        
        if(FileExists(sChatFile))
        {
            // è¯»å– tickrate
            char sTickrateFile[PLATFORM_MAX_PATH];
            if(outputSubDir != "")
            {
                BuildPath(Path_SM, sTickrateFile, sizeof(sTickrateFile), 
                    "data/botmimic/demotest/%s/tickrate.txt", 
                    g_sCurrentMatchFolder);
            }
            
            if(FileExists(sTickrateFile))
            {
                File tickFile = OpenFile(sTickrateFile, "r");
                if(tickFile != null)
                {
                    char sTickrate[32];
                    tickFile.ReadLine(sTickrate, sizeof(sTickrate));
                    TrimString(sTickrate);
                    g_fCurrentTickrate = StringToFloat(sTickrate);
                    delete tickFile;
                }
            }
            
            // åŠ è½½èŠå¤©è®°å½•ä½†å…ˆä¸å¯åŠ¨
            strcopy(g_sCurrentRoundChatFile, sizeof(g_sCurrentRoundChatFile), 
                sChatFile);
            
            PrintToServer("[Chat Replay] Chat file ready: %s", sChatFile);
            PrintMatchInfo("\x04[Match Replay] \x01ğŸ’¬ Chat replay ready");
        }
        else
        {
            PrintToServer("[Chat Replay] No chat file found for this round");
            g_sCurrentRoundChatFile[0] = '\0';
        }
    }
    // ===== èŠå¤©é‡ç°åŠŸèƒ½æ·»åŠ ç»“æŸ =====
    
    g_bRecordsReadyForAssignment = true;
    return Plugin_Stop;
}
```

#### æ­¥éª¤ 6ï¼šåœ¨ FreezeTimeEnd æ—¶å¯åŠ¨èŠå¤©

åœ¨ `Event_FreezeTimeEnd` å‡½æ•°ä¸­æ·»åŠ ï¼ˆçº¦ç¬¬1817è¡Œé™„è¿‘ï¼‰ï¼š

```sourcepawn
public void Event_FreezeTimeEnd(Event event, const char[] name, bool dontBroadcast)
{
    if(!g_bExecutingFullMatch)
        return;
    
    // ... ç°æœ‰ä»£ç  ...
    
    // ===== æ·»åŠ èŠå¤©é‡ç°å¯åŠ¨ =====
    if(g_bChatReplayEnabled && LibraryExists("demo_chat_replay") && 
       g_sCurrentRoundChatFile[0] != '\0')
    {
        ArrayList chatMessages = new ArrayList(sizeof(ChatMessageInfo));
        int count = DemoChatReplay_LoadMessages(g_sCurrentRoundChatFile, chatMessages);
        
        if(count > 0)
        {
            DemoChatReplay_Start(chatMessages, g_fCurrentTickrate);
            PrintToServer("[Chat Replay] Started with %d messages", count);
            PrintMatchInfo("\x04[Chat Replay] \x01ğŸ’¬ Replaying %d chat messages", count);
        }
        
        delete chatMessages;
    }
    // ===== èŠå¤©é‡ç°æ·»åŠ ç»“æŸ =====
}
```

#### æ­¥éª¤ 7ï¼šåœ¨å›åˆç»“æŸæ—¶åœæ­¢èŠå¤©

åœ¨ `Event_RoundEnd` å‡½æ•°ä¸­æ·»åŠ ï¼š

```sourcepawn
public void Event_RoundEnd(Event event, const char[] name, bool dontBroadcast)
{
    // ... ç°æœ‰ä»£ç  ...
    
    // ===== åœæ­¢èŠå¤©é‡ç° =====
    if(LibraryExists("demo_chat_replay") && DemoChatReplay_IsActive())
    {
        DemoChatReplay_Stop();
        PrintToServer("[Chat Replay] Stopped for round end");
    }
    // ===== æ·»åŠ ç»“æŸ =====
}
```

## ä¸‰ã€å®Œæ•´ä½¿ç”¨æµç¨‹

### 3.1 å‡†å¤‡é˜¶æ®µ

1. **è§£æ Demo æ–‡ä»¶**ï¼š
```bash
cd minidemo-encoder
minidemo-encoder.exe -dir="demoæ–‡ä»¶å¤¹è·¯å¾„"
```

2. **å¤åˆ¶è¾“å‡ºæ–‡ä»¶**ï¼š
å°† `output/[tickrate][demoName]/` ç›®å½•å¤åˆ¶åˆ°æœåŠ¡å™¨çš„ï¼š
```
csgo/addons/sourcemod/data/botmimic/demotest/[åœ°å›¾å]/[æ¯”èµ›ç¼–å·]/
```

### 3.2 æœåŠ¡å™¨è®¾ç½®

1. ç¡®ä¿å·²å®‰è£…æ’ä»¶ï¼š
   - `botmimic_fix.smx`
   - `demomimic_test.smx`ï¼ˆä¿®æ”¹åï¼‰
   - `demo_chat_replay.smx`ï¼ˆæ–°æ’ä»¶ï¼‰

2. é…ç½® ConVarsï¼ˆå¯é€‰ï¼‰ï¼š
```
sm_match_chat_replay 1      // å¯ç”¨èŠå¤©é‡ç°
sm_match_info_debug 1       // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
```

### 3.3 æ¸¸æˆä¸­ä½¿ç”¨

1. ç©å®¶è¿›å…¥æœåŠ¡å™¨åï¼Œä½¿ç”¨å‘½ä»¤ï¼š
```
!testdemo              // æ‰“å¼€å›æ”¾èœå•
```

2. é€‰æ‹© "Replay Full Match"

3. é€‰æ‹©æ˜¯å¦è·³è¿‡åˆ€å±€

4. æ¸¸æˆå¼€å§‹åï¼š
   - Bot ä¼šæŒ‰å½•åƒå›æ”¾åŠ¨ä½œ
   - èŠå¤©æ¶ˆæ¯ä¼šåœ¨åŸå§‹æ—¶é—´ç‚¹æ˜¾ç¤º
   - èŠå¤©æ¶ˆæ¯æ ¼å¼ï¼š`[CHAT] (T) player_name: message`

5. æ§åˆ¶å‘½ä»¤ï¼š
```
!chat_toggle          // å¼€å…³èŠå¤©é‡ç°
!match_status         // æŸ¥çœ‹å½“å‰çŠ¶æ€
!match_stop           // åœæ­¢æ¯”èµ›å›æ”¾
```

## å››ã€èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºæ•ˆæœ

æ¸¸æˆä¸­èŠå¤©æ¶ˆæ¯ä¼šä»¥ä»¥ä¸‹æ ¼å¼æ˜¾ç¤ºï¼š

- **å…¨å±€èŠå¤©**ï¼š`[CHAT] (T) dev1ce: nice shot`
- **é˜Ÿä¼èŠå¤©**ï¼š`[CHAT] (CT) s1mple (Team): rush B`
- é¢œè‰²æ ‡è¯†ï¼š
  - Tæ–¹ç©å®¶åï¼šé»„è‰²
  - CTæ–¹ç©å®¶åï¼šè“è‰²
  - `[CHAT]` æ ‡ç­¾ï¼šç»¿è‰²

## äº”ã€æ•…éšœæ’é™¤

### 5.1 èŠå¤©è®°å½•æ²¡æœ‰è§£æå‡ºæ¥

**å¯èƒ½åŸå› **ï¼š
- Demo æ–‡ä»¶ä¸­æ²¡æœ‰èŠå¤©æ¶ˆæ¯
- Demo æ˜¯è§‚æˆ˜è€…è§†è§’ï¼ˆGOTVï¼‰ï¼Œå¯èƒ½èŠå¤©ä¿¡æ¯ä¸å®Œæ•´

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ demo æ˜¯å¦åŒ…å«èŠå¤©ï¼ˆä½¿ç”¨ demo æ’­æ”¾å™¨éªŒè¯ï¼‰
- æŸ¥çœ‹è§£æå™¨æ—¥å¿—è¾“å‡º

### 5.2 æ¸¸æˆä¸­èŠå¤©ä¸æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•**ï¼š
1. ç¡®è®¤ `demo_chat_replay.smx` å·²åŠ è½½ï¼š
   ```
   sm plugins list
   ```

2. æ£€æŸ¥èŠå¤©æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```
   sm_chatreplay_test "æ–‡ä»¶è·¯å¾„"
   ```

3. ç¡®è®¤ ConVar è®¾ç½®ï¼š
   ```
   sm_match_chat_replay 1
   ```

4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š
   ```
   [Chat Replay] å¼€å¤´çš„æ—¥å¿—ä¿¡æ¯
   ```

### 5.3 èŠå¤©æ—¶é—´ä¸åŒæ­¥

**åŸå› **ï¼š
- Tickrate è¯»å–é”™è¯¯
- è®¡æ—¶å™¨ç²¾åº¦é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®è®¤ `tickrate.txt` æ–‡ä»¶å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å™¨ `sv_minupdaterate` å’Œ `sv_maxupdaterate` è®¾ç½®

## å…­ã€é«˜çº§åŠŸèƒ½

### 6.1 è‡ªå®šä¹‰èŠå¤©æ ¼å¼

ä¿®æ”¹ `demo_chat_replay.sp` ä¸­çš„ `DisplayChatMessage` å‡½æ•°ï¼š

```sourcepawn
void DisplayChatMessage(ChatMessageInfo msg)
{
    // è‡ªå®šä¹‰ä½ çš„èŠå¤©æ ¼å¼
    char sFormattedMsg[512];
    Format(sFormattedMsg, sizeof(sFormattedMsg), 
        "\x01[\x06å›æ”¾\x01] %s: %s",  // ä¸­æ–‡æ ‡ç­¾
        msg.sender, msg.message);
    
    PrintToChatAll("%s", sFormattedMsg);
}
```

### 6.2 èŠå¤©è¿‡æ»¤

å¯ä»¥æ·»åŠ è¿‡æ»¤åŠŸèƒ½ï¼Œåªæ˜¾ç¤ºç‰¹å®šç±»å‹çš„èŠå¤©ï¼š

```sourcepawn
// åªæ˜¾ç¤ºå…¨å±€èŠå¤©
if(msg.isTeamChat)
    return;

// åªæ˜¾ç¤ºç‰¹å®šé˜Ÿä¼
if(!StrEqual(msg.team, "T"))
    return;
```

## ä¸ƒã€API å‚è€ƒ

### 7.1 Native Functions

```sourcepawn
/**
 * åŠ è½½èŠå¤©æ¶ˆæ¯æ–‡ä»¶
 * 
 * @param chatFilePath  èŠå¤©æ–‡ä»¶è·¯å¾„
 * @param messages      å­˜å‚¨æ¶ˆæ¯çš„ ArrayList
 * @return              åŠ è½½çš„æ¶ˆæ¯æ•°é‡
 */
native int DemoChatReplay_LoadMessages(const char[] chatFilePath, ArrayList &messages);

/**
 * å¼€å§‹èŠå¤©é‡ç°
 * 
 * @param messages      èŠå¤©æ¶ˆæ¯åˆ—è¡¨
 * @param tickrate      Demo çš„ tickrate
 */
native void DemoChatReplay_Start(ArrayList messages, float tickrate);

/**
 * åœæ­¢èŠå¤©é‡ç°
 */
native void DemoChatReplay_Stop();

/**
 * æ£€æŸ¥èŠå¤©é‡ç°æ˜¯å¦æ¿€æ´»
 * 
 * @return              true=æ¿€æ´»ï¼Œfalse=æœªæ¿€æ´»
 */
native bool DemoChatReplay_IsActive();
```

### 7.2 æ•°æ®ç»“æ„

```sourcepawn
enum struct ChatMessageInfo
{
    int tick;              // æ¶ˆæ¯å‘é€çš„ tick
    char sender[64];       // å‘é€è€…åç§°
    char team[8];          // é˜Ÿä¼ï¼ˆT/CTï¼‰
    char message[256];     // æ¶ˆæ¯å†…å®¹
    bool isTeamChat;       // æ˜¯å¦ä¸ºé˜Ÿä¼èŠå¤©
}
```

## å…«ã€æ€»ç»“

é€šè¿‡è¿™ä¸ªåŠŸèƒ½ï¼Œä½ å¯ä»¥ï¼š

1. âœ… ä» demo æ–‡ä»¶ä¸­æå–æ‰€æœ‰èŠå¤©æ¶ˆæ¯
2. âœ… æŒ‰å›åˆåˆ†ç±»ä¿å­˜èŠå¤©è®°å½•
3. âœ… åœ¨æ¸¸æˆä¸­ä¸ bot å›æ”¾åŒæ­¥æ˜¾ç¤ºèŠå¤©
4. âœ… å®Œæ•´è¿˜åŸèŒä¸šæ¯”èµ›çš„äº¤æµæ°›å›´

è¿™ä½¿å¾—è§‚çœ‹ bot å›æ”¾æ›´åŠ çœŸå®å’Œæœ‰è¶£ï¼ 