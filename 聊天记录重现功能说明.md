# CS:GO Demo 聊天记录重现功能说明

## 功能概述

这个功能可以从 CS:GO demo 文件中解析聊天消息，并在游戏中通过 SourceMod 插件重现这些聊天内容，让观众可以在观看 bot 回放时看到原始比赛中的聊天交流。

## 一、Demo 解析部分（Go 语言）

### 1.1 聊天记录保存位置

解析后的聊天记录会保存在以下位置：

```
output/
├── [tickrate][demoName]/                    # Demo 输出目录
│   ├── [demoName]_chat.txt                  # 完整聊天记录（TXT格式）
│   ├── [demoName]_chat.csv                  # 完整聊天记录（CSV格式）
│   ├── round1_chat.txt                      # 第1回合聊天记录
│   ├── round2_chat.txt                      # 第2回合聊天记录
│   ├── round3_chat.txt                      # 第3回合聊天记录
│   └── round1_T0-CT0/                       # 回合录像文件夹
│       ├── t/                               # T方录像
│       ├── ct/                              # CT方录像
│       └── chat.txt                         # （未来功能：直接在回合文件夹中）
```

### 1.2 聊天记录文件格式

#### TXT 格式示例（`round1_chat.txt`）：
```
=== Chat Messages - Round 1 ===
Total Messages: 3
============================================================

[1] Tick: 5230
    Type: All
    Sender: dev1ce (Team: T)
    Message: nice shot

[2] Tick: 8450
    Type: Team
    Sender: s1mple (Team: CT)
    Message: rushing B

[3] Tick: 12300
    Type: All
    Sender: ZywOo (Team: T)
    Message: gg
```

#### CSV 格式示例（`[demoName]_chat.csv`）：
```csv
Tick,ChatType,Sender,Team,Message
5230,All,"dev1ce",T,"nice shot"
8450,Team,"s1mple",CT,"rushing B"
12300,All,"ZywOo",T,"gg"
```

### 1.3 使用方法

编译并运行解析器：

```bash
cd minidemo-encoder
go build -o minidemo-encoder.exe .\cmd\main.go

# 解析单个demo
minidemo-encoder.exe -file="path\to\demo.dem"

# 批量解析
minidemo-encoder.exe -dir="path\to\demo\folder"
```

解析过程中会在控制台输出聊天消息：
```
[Chat][Round 1][All] dev1ce (T): nice shot
[Chat][Round 2][Team] s1mple (CT): rushing B
```

## 二、游戏内重现部分（SourceMod 插件）

### 2.1 插件文件

需要以下两个文件：

1. **`demo_chat_replay.sp`** - 主插件（提供聊天重现功能）
2. **`demo_chat_replay.inc`** - 头文件（供其他插件调用）

### 2.2 安装插件

1. 编译插件：
```bash
# 将 demo_chat_replay.sp 放入 scripting/ 目录
# 编译
spcomp demo_chat_replay.sp
```

2. 复制文件：
```
addons/sourcemod/plugins/demo_chat_replay.smx
addons/sourcemod/scripting/include/demo_chat_replay.inc
```

### 2.3 使用命令

插件提供以下控制台命令：

| 命令 | 说明 | 权限 |
|------|------|------|
| `sm_chatreplay_test <文件路径>` | 测试播放聊天记录 | Admin (CONFIG) |
| `sm_chatreplay_stop` | 停止聊天重现 | Admin (CONFIG) |

示例：
```
sm_chatreplay_test "addons/sourcemod/data/botmimic/demotest/de_dust2/1/round1_chat.txt"
```

### 2.4 集成到 demomimic_test

要在 `demomimic_test.sp` 中集成聊天重现功能，需要做以下修改：

#### 步骤 1：添加 include

在文件顶部添加：
```sourcepawn
#include <sourcemod>
#include <sdktools>
#include <cstrike>
#include <botmimic>
#include <demo_chat_replay>  // 添加这一行
```

#### 步骤 2：添加全局变量

```sourcepawn
// Chat replay support
bool g_bChatReplayEnabled = true;
ConVar g_cvChatReplayEnabled;
char g_sCurrentRoundChatFile[PLATFORM_MAX_PATH];
float g_fCurrentTickrate = 64.0;
```

#### 步骤 3：在 OnPluginStart 中添加

```sourcepawn
public void OnPluginStart()
{
    // ... 现有代码 ...
    
    // Chat replay ConVar
    g_cvChatReplayEnabled = CreateConVar("sm_match_chat_replay", "1", 
        "Enable chat replay during match replay (0=off, 1=on)", 
        FCVAR_NONE, true, 0.0, true, 1.0);
    g_bChatReplayEnabled = g_cvChatReplayEnabled.BoolValue;
    
    // Chat replay command
    RegConsoleCmd("sm_chat_toggle", Cmd_ToggleChatReplay, 
        "Toggle chat replay on/off");
}
```

#### 步骤 4：添加切换命令

```sourcepawn
public Action Cmd_ToggleChatReplay(int client, int args)
{
    g_bChatReplayEnabled = !g_bChatReplayEnabled;
    g_cvChatReplayEnabled.SetBool(g_bChatReplayEnabled);
    
    if(client > 0)
    {
        if(g_bChatReplayEnabled)
        {
            PrintToChat(client, "\x04[Chat Replay] \x01聊天重现已启用");
            PrintToChat(client, "\x04[Chat Replay] \x01Chat replay enabled");
        }
        else
        {
            PrintToChat(client, "\x04[Chat Replay] \x01聊天重现已关闭");
            PrintToChat(client, "\x04[Chat Replay] \x01Chat replay disabled");
            
            // Stop current replay if active
            if(LibraryExists("demo_chat_replay"))
            {
                DemoChatReplay_Stop();
            }
        }
    }
    
    return Plugin_Handled;
}
```

#### 步骤 5：在加载回合时启动聊天重现

在 `Timer_PrepareMatchRound` 函数中添加（约第1960行附近）：

```sourcepawn
public Action Timer_PrepareMatchRound(Handle timer)
{
    // ... 现有的加载代码 ...
    
    LoadRecordsFromFolder(sTPath, g_hPendingTRecords);
    LoadRecordsFromFolder(sCtPath, g_hPendingCtRecords);
    
    // ===== 在这里添加聊天重现功能 =====
    if(g_bChatReplayEnabled && LibraryExists("demo_chat_replay"))
    {
        // 构建聊天文件路径
        char sChatFile[PLATFORM_MAX_PATH];
        Format(sChatFile, sizeof(sChatFile), "%s_chat.txt", sRoundPath);
        
        // 尝试查找 roundX_chat.txt 文件
        if(!FileExists(sChatFile))
        {
            // 尝试在 round 文件夹中查找 chat.txt
            Format(sChatFile, sizeof(sChatFile), "%s%cchat.txt", 
                sRoundPath, PATH_SEPARATOR_CHAR);
        }
        
        if(FileExists(sChatFile))
        {
            // 读取 tickrate
            char sTickrateFile[PLATFORM_MAX_PATH];
            if(outputSubDir != "")
            {
                BuildPath(Path_SM, sTickrateFile, sizeof(sTickrateFile), 
                    "data/botmimic/demotest/%s/tickrate.txt", 
                    g_sCurrentMatchFolder);
            }
            
            if(FileExists(sTickrateFile))
            {
                File tickFile = OpenFile(sTickrateFile, "r");
                if(tickFile != null)
                {
                    char sTickrate[32];
                    tickFile.ReadLine(sTickrate, sizeof(sTickrate));
                    TrimString(sTickrate);
                    g_fCurrentTickrate = StringToFloat(sTickrate);
                    delete tickFile;
                }
            }
            
            // 加载聊天记录但先不启动
            strcopy(g_sCurrentRoundChatFile, sizeof(g_sCurrentRoundChatFile), 
                sChatFile);
            
            PrintToServer("[Chat Replay] Chat file ready: %s", sChatFile);
            PrintMatchInfo("\x04[Match Replay] \x01💬 Chat replay ready");
        }
        else
        {
            PrintToServer("[Chat Replay] No chat file found for this round");
            g_sCurrentRoundChatFile[0] = '\0';
        }
    }
    // ===== 聊天重现功能添加结束 =====
    
    g_bRecordsReadyForAssignment = true;
    return Plugin_Stop;
}
```

#### 步骤 6：在 FreezeTimeEnd 时启动聊天

在 `Event_FreezeTimeEnd` 函数中添加（约第1817行附近）：

```sourcepawn
public void Event_FreezeTimeEnd(Event event, const char[] name, bool dontBroadcast)
{
    if(!g_bExecutingFullMatch)
        return;
    
    // ... 现有代码 ...
    
    // ===== 添加聊天重现启动 =====
    if(g_bChatReplayEnabled && LibraryExists("demo_chat_replay") && 
       g_sCurrentRoundChatFile[0] != '\0')
    {
        ArrayList chatMessages = new ArrayList(sizeof(ChatMessageInfo));
        int count = DemoChatReplay_LoadMessages(g_sCurrentRoundChatFile, chatMessages);
        
        if(count > 0)
        {
            DemoChatReplay_Start(chatMessages, g_fCurrentTickrate);
            PrintToServer("[Chat Replay] Started with %d messages", count);
            PrintMatchInfo("\x04[Chat Replay] \x01💬 Replaying %d chat messages", count);
        }
        
        delete chatMessages;
    }
    // ===== 聊天重现添加结束 =====
}
```

#### 步骤 7：在回合结束时停止聊天

在 `Event_RoundEnd` 函数中添加：

```sourcepawn
public void Event_RoundEnd(Event event, const char[] name, bool dontBroadcast)
{
    // ... 现有代码 ...
    
    // ===== 停止聊天重现 =====
    if(LibraryExists("demo_chat_replay") && DemoChatReplay_IsActive())
    {
        DemoChatReplay_Stop();
        PrintToServer("[Chat Replay] Stopped for round end");
    }
    // ===== 添加结束 =====
}
```

## 三、完整使用流程

### 3.1 准备阶段

1. **解析 Demo 文件**：
```bash
cd minidemo-encoder
minidemo-encoder.exe -dir="demo文件夹路径"
```

2. **复制输出文件**：
将 `output/[tickrate][demoName]/` 目录复制到服务器的：
```
csgo/addons/sourcemod/data/botmimic/demotest/[地图名]/[比赛编号]/
```

### 3.2 服务器设置

1. 确保已安装插件：
   - `botmimic_fix.smx`
   - `demomimic_test.smx`（修改后）
   - `demo_chat_replay.smx`（新插件）

2. 配置 ConVars（可选）：
```
sm_match_chat_replay 1      // 启用聊天重现
sm_match_info_debug 1       // 显示调试信息
```

### 3.3 游戏中使用

1. 玩家进入服务器后，使用命令：
```
!testdemo              // 打开回放菜单
```

2. 选择 "Replay Full Match"

3. 选择是否跳过刀局

4. 游戏开始后：
   - Bot 会按录像回放动作
   - 聊天消息会在原始时间点显示
   - 聊天消息格式：`[CHAT] (T) player_name: message`

5. 控制命令：
```
!chat_toggle          // 开关聊天重现
!match_status         // 查看当前状态
!match_stop           // 停止比赛回放
```

## 四、聊天消息显示效果

游戏中聊天消息会以以下格式显示：

- **全局聊天**：`[CHAT] (T) dev1ce: nice shot`
- **队伍聊天**：`[CHAT] (CT) s1mple (Team): rush B`
- 颜色标识：
  - T方玩家名：黄色
  - CT方玩家名：蓝色
  - `[CHAT]` 标签：绿色

## 五、故障排除

### 5.1 聊天记录没有解析出来

**可能原因**：
- Demo 文件中没有聊天消息
- Demo 是观战者视角（GOTV），可能聊天信息不完整

**解决方法**：
- 检查 demo 是否包含聊天（使用 demo 播放器验证）
- 查看解析器日志输出

### 5.2 游戏中聊天不显示

**检查清单**：
1. 确认 `demo_chat_replay.smx` 已加载：
   ```
   sm plugins list
   ```

2. 检查聊天文件是否存在：
   ```
   sm_chatreplay_test "文件路径"
   ```

3. 确认 ConVar 设置：
   ```
   sm_match_chat_replay 1
   ```

4. 查看服务器日志：
   ```
   [Chat Replay] 开头的日志信息
   ```

### 5.3 聊天时间不同步

**原因**：
- Tickrate 读取错误
- 计时器精度问题

**解决方法**：
- 确认 `tickrate.txt` 文件存在且内容正确
- 检查服务器 `sv_minupdaterate` 和 `sv_maxupdaterate` 设置

## 六、高级功能

### 6.1 自定义聊天格式

修改 `demo_chat_replay.sp` 中的 `DisplayChatMessage` 函数：

```sourcepawn
void DisplayChatMessage(ChatMessageInfo msg)
{
    // 自定义你的聊天格式
    char sFormattedMsg[512];
    Format(sFormattedMsg, sizeof(sFormattedMsg), 
        "\x01[\x06回放\x01] %s: %s",  // 中文标签
        msg.sender, msg.message);
    
    PrintToChatAll("%s", sFormattedMsg);
}
```

### 6.2 聊天过滤

可以添加过滤功能，只显示特定类型的聊天：

```sourcepawn
// 只显示全局聊天
if(msg.isTeamChat)
    return;

// 只显示特定队伍
if(!StrEqual(msg.team, "T"))
    return;
```

## 七、API 参考

### 7.1 Native Functions

```sourcepawn
/**
 * 加载聊天消息文件
 * 
 * @param chatFilePath  聊天文件路径
 * @param messages      存储消息的 ArrayList
 * @return              加载的消息数量
 */
native int DemoChatReplay_LoadMessages(const char[] chatFilePath, ArrayList &messages);

/**
 * 开始聊天重现
 * 
 * @param messages      聊天消息列表
 * @param tickrate      Demo 的 tickrate
 */
native void DemoChatReplay_Start(ArrayList messages, float tickrate);

/**
 * 停止聊天重现
 */
native void DemoChatReplay_Stop();

/**
 * 检查聊天重现是否激活
 * 
 * @return              true=激活，false=未激活
 */
native bool DemoChatReplay_IsActive();
```

### 7.2 数据结构

```sourcepawn
enum struct ChatMessageInfo
{
    int tick;              // 消息发送的 tick
    char sender[64];       // 发送者名称
    char team[8];          // 队伍（T/CT）
    char message[256];     // 消息内容
    bool isTeamChat;       // 是否为队伍聊天
}
```

## 八、总结

通过这个功能，你可以：

1. ✅ 从 demo 文件中提取所有聊天消息
2. ✅ 按回合分类保存聊天记录
3. ✅ 在游戏中与 bot 回放同步显示聊天
4. ✅ 完整还原职业比赛的交流氛围

这使得观看 bot 回放更加真实和有趣！ 